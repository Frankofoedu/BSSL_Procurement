@page
@model BsslProcurement.Pages.Vendor.PrequalificationModel
@{
    ViewData["Title"] = "Prequalification";
}
@if (!string.IsNullOrWhiteSpace(Model.Message))
{
    <div class="alert alert-success alert-dismissable fade show">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        @Model.Message
    </div>
}
@if (!string.IsNullOrWhiteSpace(Model.Error))
{
    <div class="alert alert-danger alert-dismissable fade show">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        @Model.Error
    </div>
}

<div class="row mt-5">
    <div class="col-md-1"></div>
    <div class="col-md-10">
        <form method="post" class="panel panel-login" enctype="multipart/form-data">
            <div class="panel-heading">
                <div class="row">
                    <p class="header-text">Vendor Pre-qualification</p>
                </div>
                <hr>
            </div>
            <div asp-validation-summary="All" class="text-danger"></div>

            <div class="row">
                <div class="col-12">
                    <h3 class="h3 bg-primary text-white px-3 py-1 mt-2 rounded">
                        Company Details.
                    </h3>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Rc No/ITF No </label>
                        <input class="form-control" asp-for="CompanyInfo.CompanyRegNo" placeholder="Enter Rc or ITF Number" />
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Company Name</label>
                        <input class="form-control" asp-for="CompanyInfo.CompanyName" placeholder="Enter Company Name" />
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input class="form-control" asp-for="CompanyInfo.PhoneNumber" placeholder="Enter ONE(1) Phone Number" />
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input class="form-control" asp-for="CompanyInfo.Email" placeholder="Enter ONE(1) Email Address" />
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Password</label>
                        @* TODO move password to identity *@
                        <input class="form-control" asp-for="CompanyInfo.Password" type="password" placeholder="Enter Password" />
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input class="form-control" type="password" placeholder="Repeat Password" />
                    </div>
                </div>
                <div class="col-sm-12">
                    <div class="form-group">
                        <label>Company Address </label>
                        <input class="form-control" asp-for="CompanyInfo.Address" placeholder="Enter Company Address" />
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Select State</label>
                        <select class="states form-control" asp-for="CompanyInfo.State">
                        </select>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Select LGA</label>
                        <select class="lgas form-control" asp-for="CompanyInfo.City">
                        </select>
                    </div>
                </div>
                <div class="col-sm-12">
                    <div class="form-group">
                        <label>Postal Address</label>
                        <input class="form-control" asp-for="CompanyInfo.PostalAddress" placeholder="Enter Postal Address" />
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Nature of Business </label>
                        <select class="form-control" asp-for="CompanyInfo.NatureOfBusiness">
                            <option>--Select--</option>
                        </select>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Economic Sector</label>
                        <select class="form-control" asp-for="CompanyInfo.Sector">
                            <option>--Select--</option>
                        </select>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Date of Establishment</label>
                        <input class="form-control" asp-for="CompanyInfo.DateEstablishment" />
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Tax Identification Number (TIN)</label>
                        <input class="form-control" placeholder="Enter Tax Identification Number" asp-for="CompanyInfo.TIN" />
                    </div>
                </div>
            </div>


            <div class="row">
                <div class="col-12">
                    <h3 class="h3 bg-primary text-white px-3 py-1 mt-2 rounded">
                        Contact Person Details
                    </h3>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Name </label>
                        <input class="form-control" placeholder="Enter Fullname" asp-for="CompanyInfo.ContactName" />
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Designation </label>
                        <input class="form-control" placeholder="Enter Designation in Company" asp-for="CompanyInfo.ContactDesignation" />
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input class="form-control" placeholder="Enter ONE(1) Phone Number" asp-for="CompanyInfo.ContactPhoneNumber" />
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input class="form-control" placeholder="Enter ONE(1) Email Address" type="email" asp-for="CompanyInfo.ContactEmail" />
                    </div>
                </div>
            </div>


            <div class="row">
                <div class="col-12">
                    <h3 class="h3 bg-primary text-white px-3 py-1 mt-2 rounded">
                        Category of Contract for Prequalification
                    </h3>
                </div>
            </div>
            <div class="row">
                @for (int i = 0; i < Model.CategoryCount; i++)
                {

                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>Main Category </label>
                            <select class="form-control" onchange="getSubCategories(this.value, @i);" asp-items="Model.Categories">
                                <option>--Select--</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>Sub Category </label>
                            <select id="ddlSelectCategory_@i" class="form-control">
                                <option>--Select--</option>
                            </select>
                        </div>
                    </div>
                }
            </div>


            <div class="text-center p-3">
                <button id="btnHideDocs" onclick="getCatAndhideDocBtn(); return false" class="btn btn-info ">Add Documents and Requirements</button>
            </div>

            <div class="row">
                <div class="col-12">
                    <h3 class="h3 bg-primary text-white px-3 py-1 mt-2 rounded">
                        Documents and Requirements
                    </h3>
                </div>
            </div>

            <div id="ShowDocs" class="row" style="">
                <div class="col-12">
                    @*<input type="button" value="Test" onclick="addDocFields();" />*@
                    <table class="table table-responsive-sm table-striped">
                        <thead>
                            <tr class="table-primary">
                                <th>S/N</th>
                                <th>Requirement</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody id="table_docs">

                            @*<tr>
                                    <td>(1) <input type="hidden"  asp-for="DocImages[0].Id" value="1"/></td>
                                    <td><input type="file" class="form-control-file" asp-for="DocImages[0].Image" /></td>
                                </tr>*@
                        </tbody>
                    </table>
                </div>
            </div>


            <div class="row">
                <div class="col-12">
                    <h3 class="h3 bg-primary text-white px-3 py-1 mt-2 rounded">
                        Experience Record
                    </h3>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <table class="table table-responsive table-striped">
                        <thead>
                            <tr class="table-primary">
                                <th>S/N</th>
                                <th>Client Name</th>
                                <th>Client Address</th>
                                <th>Project Description</th>
                                <th>Start Date</th>
                                <th>Completion Date</th>
                                <th>Contact Person</th>
                                <th>Phone Number</th>
                            </tr>
                        </thead>
                        <tbody id="experienceTbody">
                            @for (int i = 0; i < 1; i++)
                            {
                                <tr>
                                    <td>@(i + 1)</td>
                                    <td><input type="text" class="form-control-sm" asp-for="ExperienceRecords[i].Name" /></td>
                                    <td><input type="text" class="form-control-sm" asp-for="ExperienceRecords[i].Address" /></td>
                                    <td><input type="text" class="form-control-sm" asp-for="ExperienceRecords[i].ProjectDescription" /></td>
                                    <td><input type="text" class="form-control-sm" asp-for="ExperienceRecords[i].StartDate" /></td>
                                    <td><input type="text" class="form-control-sm" asp-for="ExperienceRecords[i].CompletionDate" /></td>
                                    <td><input type="text" class="form-control-sm" asp-for="ExperienceRecords[i].ContactPerson" /></td>
                                    <td><input type="text" class="form-control-sm" asp-for="ExperienceRecords[i].PhoneNumber" /></td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <input id="experienceLastIndex" type="hidden" value="0">
                    <button id="btnAddMoreExperience" class=""> Add More</button>
                </div>
            </div>


            <div class="row">
                <div class="col-12">
                    <h3 class="h3 bg-primary text-white px-3 py-1 mt-2 rounded">
                        Equipment Details
                    </h3>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <table class="table table-responsive-sm table-striped">
                        <thead>
                            <tr class="table-primary">
                                <th>S/N</th>
                                <th>Equipment Name</th>
                                <th>Equipment Description</th>
                                <th>Quantity</th>
                            </tr>
                        </thead>
                        <tbody id="equipmentTbody">
                            @for (int i = 0; i < 1; i++)
                            {
                                <tr>
                                    <td>@(i + 1)</td>
                                    <td><input type="text" class="form-control" asp-for="EquipmentDetails[i].Name" /></td>
                                    <td><input type="text" class="form-control" asp-for="EquipmentDetails[i].Description" /></td>
                                    <td><input type="text" class="form-control" asp-for="EquipmentDetails[i].Quantity" /></td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <input id="equipmentLastIndex" type="hidden" value="0">
                    <button id="btnAddMoreEquipment" class=""> Add More</button>
                </div>
            </div>


            <div class="row">
                <div class="col-12">
                    <h3 class="h3 bg-primary text-white px-3 py-1 mt-2 rounded">
                        Key Personnel Details
                    </h3>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <table class="table table-responsive-sm table-striped">
                        <thead>
                            <tr class="table-primary">
                                <th>S/N</th>
                                <th>Name</th>
                                <th>Professional Qualification</th>
                                <th>CV</th>
                                <th>Professional Certificate</th>
                                <th>Passport Photograph</th>
                            </tr>
                        </thead>
                        <tbody id="personnelTbody">
                            @for (int i = 0; i < 1; i++)
                            {
                                <tr>
                                    <td> @(i + 1) </td>
                                    <td><input type="text" class="form-control" asp-for="PersonnelDetailIntputs[i].Name" /></td>
                                    <td><input type="text" class="form-control" asp-for="PersonnelDetailIntputs[i].Qualification" /></td>
                                    <td><input type="file" class="form-control-file" asp-for="PersonnelDetailIntputs[i].CVFile" /></td>
                                    <td><input type="file" class="form-control-file" asp-for="PersonnelDetailIntputs[i].CertFile" /></td>
                                    <td><input type="file" class="form-control-file" asp-for="PersonnelDetailIntputs[i].PassportFile" /></td>
                                </tr>
                            }


                        </tbody>

                    </table>
                    <input id="personnelLastIndex" type="hidden" value="0">
                    <button id="btnAddMorePersonnel" class=""> Add More</button>
                </div>
            </div>

            <div class="col-12 mt-4">
                <div class="form-group">
                    <div class="row">
                        <div class="col-sm-4 text-center">
                            <button type="submit" class="btn btn-outline-primary">Save for Later</button>
                        </div>
                        <div class="col-sm-4">
                            <button type="submit" class="btn form-btn">Submit</button>
                        </div>
                        <div class="col-sm-4 text-center">
                            <button type="submit" class="btn btn-outline-dark">Print/Preview Form</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <hr />
    </div>
</div>
    <script src="~/js/StatenLGA.js" ></script>

<script>

    $(document).ready(function () {

        for (var i = 0; i < states.length; i++) {
            var o = new Option(states[i].state.name, states[i].state.name);
            $(o).html(states[i].state.name);
            $('.states').append(o);
        }

        $('.states').on('change', function () {
            displayLGA();
        });

        displayLGA();

        $('#btnAddMorePersonnel').on('click', function (event) {
            var lastIndex = $('#personnelLastIndex').val();
            var newIndex = Number(lastIndex) + 1;

            newPersonnelRow(newIndex);
            $('#personnelLastIndex').val(newIndex);
            return false;
        });

        $('#btnAddMoreEquipment').on('click', function (event) {
            var lastIndex = $('#equipmentLastIndex').val();
            var newIndex = Number(lastIndex) + 1;

            newEquipmentRow(newIndex);
            $('#equipmentLastIndex').val(newIndex);
            return false;
        });

        $('#btnAddMoreExperience').on('click', function (event) {
            var lastIndex = $('#experienceLastIndex').val();
            var newIndex = Number(lastIndex) + 1;

            newExperienceRow(newIndex);
            $('#experienceLastIndex').val(newIndex);
            return false;
        });

    });

    function newPersonnelRow(index) {
        var html = ' <tr> <td>' + (Number(index) + 1) + '</td > <td>' +
            '<input type="text" class="form-control" id="PersonnelDetailIntputs_' + index + '__Name" name="PersonnelDetailIntputs[' + index + '].Name" value="" /></td>' +
            '<td><input type="text" class="form-control" id="PersonnelDetailIntputs_' + index + '__Qualification" name="PersonnelDetailIntputs[' + index + '].Qualification" value="" /></td>' +
            '<td><input type="file" class="form-control-file" id="PersonnelDetailIntputs_' + index + '__CVFile" name="PersonnelDetailIntputs[' + index + '].CVFile" /></td>' +
            '<td><input type="file" class="form-control-file" id="PersonnelDetailIntputs_' + index + '__CertFile" name="PersonnelDetailIntputs[' + index + '].CertFile" /></td>' +
            '<td><input type="file" class="form-control-file" id="PersonnelDetailIntputs_' + index + '__PassportFile" name="PersonnelDetailIntputs[' + index + '].PassportFile" /></td>' +
            '</tr>';

        $('#personnelTbody').append(html);
    }

    function newEquipmentRow(index) {
        var html = ' <tr> <td>' + (Number(index) + 1) + '</td > <td>' +
            '<input type="text" class="form-control" id="EquipmentDetails_' + index + '__Name" name="EquipmentDetails[' + index + '].Name" value="" /></td>' +
            '<td><input type="text" class="form-control" id="EquipmentDetails_' + index + '__Description" name="EquipmentDetails[' + index + '].Description" value="" /></td>' +
            '<td><input type="text" class="form-control" id="EquipmentDetails_' + index + '__Quantity" name="EquipmentDetails[' + index + '].Quantity" value="" /></td>' +
            '</tr>';

        $('#equipmentTbody').append(html);
    }

    function newExperienceRow(index) {
        var html = ' <tr> <td>' + (Number(index) + 1) + '</td > <td>' +
            '<input type="text" class="form-control" id="ExperienceRecords_' + index + '__Name" name="ExperienceRecords[' + index + '].Name" value="" /></td>' +
            '<td><input type="text" class="form-control" id="ExperienceRecords_' + index + '__Address" name="ExperienceRecords[' + index + '].Address" value="" /></td>' +
            '<td><input type="text" class="form-control" id="ExperienceRecords_' + index + '__ProjectDescription" name="ExperienceRecords[' + index + '].ProjectDescription" value="" /></td>' +
            '<td><input type="text" class="form-control" id="ExperienceRecords_' + index + '__StartDate" name="ExperienceRecords[' + index + '].StartDate" value="" /></td>' +
            '<td><input type="text" class="form-control" id="ExperienceRecords_' + index + '__CompletionDate" name="ExperienceRecords[' + index + '].CompletionDate" value="" /></td>' +
            '<td><input type="text" class="form-control" id="ExperienceRecords_' + index + '__ContactPerson" name="ExperienceRecords[' + index + '].ContactPerson" value="" /></td>' +
            '<td><input type="text" class="form-control" id="ExperienceRecords_' + index + '__PhoneNumber" name="ExperienceRecords[' + index + '].PhoneNumber" value="" /></td>' +
            '</tr>';

        $('#experienceTbody').append(html);
    }

    function getCatAndhideDocBtn() {
        var listCatsId = [];
        for (var i = 0; i < @Model.CategoryCount; i++) {
            //remove non selected criterias
            var id = +($('#ddlSelectCategory_' + i).val());

            if (!Number.isNaN(id)) {
                listCatsId.push(id);
            }

        }

        getCriterias(listCatsId);

        //disable button after adding docs field
        $('#btnHideDocs').prop('disabled', true);

        //show docs div
        $('#ShowDocs').show(1000);
       // console.log(listCatsId);

    }

    //
    function addDocFields(counter,pscid, CriId, isDoc, mval,desc ) {
        if (isDoc) {
            //requires a file

            //file control
            var control = '<tr><td>' + counter + 1 + '</td><td>' + desc +
                '</td><td><input id="DocsList_' + counter +
                '_Image" name="DocsList[' + counter +
                '].Image" type="file" class="form-control-file" value /></td></tr>';

            //hidden field to store the id
            var hidControl = '<tr><td><input id="DocsList_' + counter +
                '_Id" name="DocsList[' + counter +
                '].Id" type="hidden" value=' + CriId + ' /></td></tr>';

            //hidden field for the bool doc test
            var hidControl = '<tr><td><input id="DocsList_' + counter +
                '_Id" name="DocsList[' + counter +
                '].Id" type="hidden" value=' + isDoc + ' /></td></tr>';


            $('#table_docs').append(control);
            $('#table_docs').append(hidControl);
        } else {
            //no file required

            //value control
            var control = '<tr><td>' + counter + 1 + '</td><td>' + desc +
                '</td><td><input id="SubmittedCriterias_' + counter +
                '__Value" name="SubmittedCriterias[' + counter +
                '].Value" type="text" class="form-control" value='+mVal+' /></td></tr>';


            //hidden field to store the id
            var hidControl = '<tr><td><input id="DocsList_' + counter +
                '_Id" name="DocsList[' + counter +
                '].Id" type="hidden" value='+CriId+' /></td></tr>';

           $('#table_docs').append(control);
            $('#table_docs').append(hidControl);
        }
    }

    //get docs and requirements
    function getCriterias(listInt) {
        var baseUrl = window.location.origin;
        //var myJSON = JSON.stringify(listInt);

        //var tes = [1, 2, 3];
        //console.log(tes);
        $.ajax({
            contentType:'application/json; charset=utf-8',
            url: baseUrl + '/api/SubCategoryCriterias/ListSubCategoryCriteria' ,
            data: { ids: listInt },
           traditional:true,
            type: 'get',
            xhrFields: {
                withCredentials: true
            },
            contentType: 'application/json',
            error: function () {
                alert('error Invalid Code.');
            }, success: function (data) {
                if (!data) {
                    alert('good Invalid Code.');
                } else {

                    for (var i = 0; i < data.length; i++) {

                        var item = data[i];

                        var pscID = item.procurementSubcategoryId;
                        var Criteriaid = item.id;
                        var needsDoc = item.needsDocument;
                        var minVal = item.minValue;
                        var isCompul = item.isCompulsory;
                        var critDesc = item.criteriaDescription;


                        addDocFields(i, pscID, Criteriaid, needsDoc, minVal, critDesc);
                    }
                    console.log(data);
                }
            }
        })

    }

    function getSubCategories(id, counter) {
        //alert("started" + id);
        $.getJSON("https://localhost:5001/DynamicData/SubCategories?id=" + id,
            function (result) {
                if (result.length > 0) {
                    // alert('Done');
                    $('#ddlSelectCategory_' + counter).empty();
                    $('#ddlSelectCategory_' + counter).append($('<option>').text("Select"));
                    $.each(result, function (i, obj) {

                        $('#ddlSelectCategory_' + counter).append($('<option>').text(obj.name).attr('value', obj.value));
                    });
                   // console.log(result);

                } else {

                    $('#ddlSelectCategory_' + counter).empty();
                    $('#ddlSelectCategory_' + counter).append($('<option>').text("Select"));
                }
            })
            .fail(function (error) {
                // alert('Done');
                console.log(error);
            });
        }

    function displayLGA() {
        var selVal = $('.states').val();
        $(".lgas").html("");

        var locals = [];
        for (var i = 0; i < states.length; i++) {
            if (states[i].state.name == selVal) {
                locals = states[i].state.locals;
                break;
            }
        }

        for (var i = 0; i < locals.length; i++) {

            var o = new Option(locals[i].name, locals[i].name);
            $(o).html(locals[i].name);
                $(".lgas").append(o);

        }
    }
</script>