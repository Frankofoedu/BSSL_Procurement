@page
@model BsslProcurement.Pages.Staff.Workflow.WorkflowStaffModel
@{
    ViewData["Title"] = "WorkflowStaff";
}
@section Styles{

    <link href="~/css/jquery.dataTables.min.css" rel="stylesheet" />
    <style>
        .loader {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

        @@keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .faRedColour {
            color: red;
        }
    </style>
}
<div class="row my-3">
    <div class="col-lg-3"></div>
    <div class="col-lg-6">
        <div class="panel panel-login">
            <div class="panel-heading">
                <div class="row">
                    <p class="header-text">@(Model.curWorkflow.WorkflowType.Name + " " + Model.curWorkflow.WorkflowAction.Name) Staff Setup</p>
                </div>
                <hr>
            </div>

            <div class="mt-1">
                <table class="table table-striped">
                    <thead>
                        <tr class="table-primary">
                            <th>S/N</th>
                            <th>Staff Name</th>
                        </tr>
                    </thead>
                    <tbody id="workflowBody">
                        @for (int i = 0; i < Model.WorkflowStaffs.Count; i++)
                        {
                            var item = Model.WorkflowStaffs[i];

                        <tr>
                            <td>@(i+1)</td>

                            <td>@item.Staff.Name</td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-lg-3"></div>
    <div class="col-lg-6 justify-content-center">
        <form method="post" class="panel panel-login">
            <div class="panel-heading">
                <div class="row">
                    <h3>Add New Staff @(Model.curWorkflow.WorkflowType.Name + " " + Model.curWorkflow.WorkflowAction.Name) Staff Setup</h3>
                    <input type="hidden" asp-for="curWorkflowId" />
                </div>
                <hr>
            </div>

            @if (!string.IsNullOrWhiteSpace(Model.Message))
            {
            <div class="alert alert-success alert-dismissable fade show">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                @Model.Message
            </div>
            }
            @if (!string.IsNullOrWhiteSpace(Model.Error))
            {
            <div class="alert alert-danger alert-dismissable fade show">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                @Model.Error
            </div>
            }

            <div asp-validation-summary="All" class="text-danger"></div>

            <div class="row justify-content-center">
                <div class="col-md-12">
                    <div class="card mt-3">
                        <div class="card-body">
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-sm-4 text-sm-right">
                                        <label class="mt-2">Staff Code</label>
                                    </div>
                                    <div class="col-sm-8">
                                        <span class="d-flex flex-row">
                                            <input asp-for="newWorkflowStaff.StaffId" class="staffCodeInput form-control" readonly />
                                            <button class="btn loadStaffModal ml-1" value="txtprepared"><i class="fa fa-search"></i></button>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-sm-4 text-sm-right">
                                        <label class="mt-2">Staff Name</label>
                                    </div>
                                    <div class="col-sm-8">
                                        <input type="text" readonly="readonly" class="staffNameInput form-control" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-sm-3"> </div>
                                    <div class="col-sm-6 text-center">
                                        <button type="submit" class="btn btn-primary ml-sm-2">Save</button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </form>
    </div>
</div>

<div class="modal" id="staffModal">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Staff Details</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="grid"></div>
            </div>
            <div id="spinner" class="d-flex justify-content-center">
                <div class="loader">
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="hiddenURLNoRank" value="@Url.Action("GetStaffNoRank", "Staff")" />
@section Scripts{

    <script src="~/js/jquery.dataTables.min.js"></script>

    <script>

        $(document).ready(function () {

            //function fetchWorkflows() {
            //    var select = document.getElementById("categorySelect");
            //    var id = select.value;
            //    $("#CategoryId").val(id);
            //    $('.workflowType').text(select.options[select.selectedIndex].innerHTML);

            //    if (id) {

            //        var baseUrl = window.location.origin;

            //        $.ajax({
            //            url: baseUrl + '/api/Workflow/WorkflowStaff/' + id.trim(),
            //            type: 'get',
            //            xhrFields: {
            //                withCredentials: true
            //            },
            //            contentType: 'application/json',
            //            error: function () {
            //                alert('An Error occured...');
            //            },
            //            success: function (data) {
            //                if (!data) {
            //                    alert('No Workflow for the selected category.');
            //                    return;
            //                }

            //                displayWorkflow(data);
            //            },
            //        });
            //    }
            //}

            //function displayWorkflow(workflows) {
            //    $("#workflowBody").html("");

            //    for (var i = 0; i < workflows.length; i++) {
            //        $("#workflowBody").append(NewWorkflowRow(workflows[i]));
            //    }
            //}

            //function NewWorkflowRow(workflow) {
            //    var html = '<tr> <td>' + workflow.workflowAction.name + '</td> <td>' + workflow.staff.name + '</td> </tr>';

            //    return html;
            //}


            //$('#categorySelect').change(function () { fetchWorkflows(); });
        });

        //to load staff modal
        $(function () {
            $('.loadStaffModal').on('click', function () {
                $('#grid').empty();
                $('#spinner').addClass('d-flex');
                $('#spinner').show();
                $('#staffModal').modal("show");

                var url = $('#hiddenURLNoRank').val();
                $('#grid').load(url, function () {
                    $('#spinner').removeClass('d-flex');
                    $('#spinner').hide();
                    $('#staffTable').dataTable();

                    $('#staffTable').on('click','.btnStaffName',function () {
                        //assign staff Id textbox
                        var code = $(this).text();
                        $('.staffCodeInput').val(code);

        //code to get the staff rank
                        $.ajax({
                            type: "GET",
                            url: `/api/Users/GetStaffRank/${code}`,
                            contentType: "application/json; charset=utf-8",
                            success: function (data) {
                                //alert(JSON.stringify(data));                  
                               
                                console.log(data);
                            }, //End of AJAX Success function  

                            failure: function (data) {
                                alert(data.responseText);
                            }, //End of AJAX failure function  
                            error: function (data) {
                                alert(data.responseText);
                            } //End of AJAX error function  

                        });    
                        //assign staff name textbox
                        $('.staffNameInput').val($(this).val());

                        //$('#forStaffText').val();
                        $('#staffModal').modal("hide");
                        return false;
                    });
                });

                return false;
            });
        });

    </script>
}
